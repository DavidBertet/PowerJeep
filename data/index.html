<!DOCTYPE html>
<html>
  <head>
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0"
    />
    <meta charset="utf8" />
    <title>PowerJeep</title>

    <link rel="stylesheet" href="styles.css">

    <script language="javascript" type="text/javascript">
      var url = "ws://192.168.4.1:80/ws";
      var emergency_stop = false;
      var websocket;

      // Cache views
      var loader;
      var speedGaugeValue;
      var speedGaugeUnit;
      var speedGaugeFrontground;
      var stopButton;
      var maxForwardInput;
      var maxBackwardInput;
      var saveButton;
      var output;

      function init() {
        loader = document.getElementById("loader");
        speedGaugeValue = document.getElementById("speed_gauge_value");
        speedGaugeUnit = document.getElementById("speed_gauge_unit");
        speedGaugeFrontground = document.getElementById(
          "speed_gauge_frontground"
        );
        stopButton = document.getElementById("stopButton");
        maxForwardInput = document.getElementById("maxForwardInput");
        maxBackwardInput = document.getElementById("maxBackwardInput");
        saveButton = document.getElementById("saveButton");
        output = document.getElementById("output");

        initDrag();

        // Initial state
        isConnecting(true);
        updateEmergencyStop(false);
        updateGauge(0, false);

        // Start connection
        wsConnect(url);
      }

      // **************
      //   Websocket
      // **************

      function wsConnect(url) {
        websocket = new WebSocket(url);

        websocket.onopen = function (evt) {
          onOpen(evt);
        };
        websocket.onclose = function (evt) {
          onClose(evt);
        };
        websocket.onmessage = function (evt) {
          onMessage(evt);
        };
        websocket.onerror = function (evt) {
          onError(evt);
        };
      }

      function onOpen(event) {
        console.log("Connected");

        wsSend(JSON.stringify({ command: "read" }));

        output.innerHTML = "Connected";

        isConnecting(false);
      }

      function onClose(event) {
        console.log("Disconnected");

        output.innerHTML = "Disconnected";

        isConnecting(true);

        setTimeout(() => {
          wsConnect(url);
        }, 2000);
      }

      function onMessage(event) {
        console.log("Received " + event.data);

        json = JSON.parse(event.data);
        if (json.loaded != undefined && json.total != undefined) {
          progressHandler(json.loaded, json.total);
          return;
        }
        if (json.emergency_stop != undefined) {
          updateEmergencyStop(json.emergency_stop);
        }
        if (json.current_speed != undefined) {
          updateGauge(Math.abs(json.current_speed), json.emergency_stop || false);
        }
        if (json.max_forward != undefined) {
          maxForwardInput.value = json.max_forward;
          document.getElementById("maxForwardInputValue").innerHTML =
            json.max_forward;
        }
        if (json.max_backward != undefined) {
          maxBackwardInput.value = json.max_backward;
          document.getElementById("maxBackwardInputValue").innerHTML =
            json.max_backward;
        }
      }

      function onError(event) {
        console.log("Error " + event.data);
      }

      function wsSend(data) {
        console.log("Sending " + data);
        websocket.send(data);
      }

      // **************
      //   State update
      // **************

      function isConnecting(isConnecting) {
        if (
          (isConnecting && loader.style.visibility == "visible") ||
          (!isConnecting && loader.style.visibility == "hidden")
        ) {
          return;
        }

        loader.classList.add(isConnecting ? "visible" : "hidden");
        loader.classList.remove(isConnecting ? "hidden" : "visible");

        if (isConnecting) updateLoader();
      }

      function updateLoader() {
        if (loader.style.visibility == "visible") {
          setTimeout(() => {
            updateLoader();
          }, 1000);

          loader.innerHTML += ".";
          if (loader.innerHTML.endsWith("....")) {
            loader.innerHTML = loader.innerHTML.replace("....", "");
          }
        }
      }

      function updateGauge(value, isEmergencyStop) {
        if (isEmergencyStop) {
          speedGaugeValue.innerHTML = "ðŸš«";
          speedGaugeUnit.style.display = "none";
          speedGaugeFrontground.style.strokeDashoffset = 147;
          speedGaugeFrontground.style.stroke = "red";
        } else {
          value = Math.round(value);
          speedGaugeValue.innerHTML = value;
          speedGaugeUnit.style.display = "block";
          // 0% is 440, 100% is 147
          speedGaugeFrontground.style.strokeDashoffset =
            440 - (440 - 147) * (value / 100);
          speedGaugeFrontground.style.stroke = "url(#GradientColor)";
        }
      }

      function updateEmergencyStop(isEmergencyStop) {
        emergency_stop = isEmergencyStop;
        stopButton.innerHTML = isEmergencyStop ? "Restart" : "Emergency Stop";
      }

      function showDialog() {
        document.body.classList.add("dialog-active");

        dialog = document.getElementById("dialog-container");
        dialog.classList.remove("out");
        dialog.classList.add("show");
      }

      function hideDialog() {
        document.body.classList.remove("dialog-active");

        dialog = document.getElementById("dialog-container");
        dialog.classList.add("out");
      }

      // **************
      //   Actions
      // **************

      function initDrag() {
        let input = document.querySelectorAll(".file_container")[0];

        input.addEventListener("dragenter", function (e) {
          document.getElementById("upload2").classList.add("bounce");
        });

        input.addEventListener("dragleave", function (e) {
          document.getElementById("upload2").classList.remove("bounce");
        });
      }

      function onPressEmergencyStop(event) {
        wsSend(
          JSON.stringify({
            command: "emergency_stop",
            parameters: { is_enabled: !emergency_stop },
          })
        );

        return false;
      }

      function onPressSave(event) {
        if (isNaN(maxForwardInput.value) || isNaN(maxBackwardInput.value)) {
          output.innerHTML = "Error, not a number";
          return false;
        }
        wsSend(
          JSON.stringify({
            command: "update_max",
            parameters: {
              max_forward: parseInt(maxForwardInput.value),
              max_backward: parseInt(maxBackwardInput.value),
            },
          })
        );

        return false;
      }

      function onSliderInput(event) {
        document.getElementById(event.id + "Value").innerHTML = event.value;
      }

      window.addEventListener("load", init, false);
    </script>
  </head>
  <body>
    <div id="loader">Connecting ...</div>

    <div id="dialog-container">
      <div class="dialog-background">
        <div class="dialog">
          <h1>Upload</h1>
          <div id="filepath"></div>
          <progress
            id="progressBar"
            value="0"
            max="100"
            style="width: 300px"
          ></progress>
          <div id="status">Upload will began soon</div>
        </div>
      </div>
    </div>

    <div class="content">
      <h2>PowerJeep</h2>

      <div class="gauge">
        <div class="gauge_text">
          <div id="speed_gauge_value" class="gauge_value">0</div>
          <div id="speed_gauge_unit" class="gauge_unit">%</div>
        </div>
        <svg
          class="gauge_svg"
          xmlns="http://www.w3.org/2000/svg"
          version="1.1"
          preserveAspectRatio="xMidYMid meet"
          viewBox="0 0 180 180"
        >
          <defs>
            <filter id="shadow" color-interpolation-filters="sRGB">
              <feDropShadow
                dx="3"
                dy="3"
                stdDeviation="5"
                flood-opacity="0.7"
                flood-color="#000"
              />
              <feDropShadow
                dx="-3"
                dy="-3"
                stdDeviation="3"
                flood-opacity="0.15"
                flood-color="#fff"
              />
            </filter>
            <linearGradient id="GradientColor">
              <stop offset="0%" stop-color="var(--gauge-100)" />
              <stop offset="50%" stop-color="var(--gauge-50)" />
              <stop offset="100%" stop-color="var(--gauge-0)" />
            </linearGradient>
          </defs>
          <circle
            class="gauge_background"
            cx="90"
            cy="90"
            r="70"
            stroke-linecap="round"
          />
          <circle
            id="speed_gauge_frontground"
            class="gauge_frontground"
            cx="90"
            cy="90"
            r="70"
            stroke-linecap="round"
          />
        </svg>
      </div>

      <button id="stopButton" onclick="return onPressEmergencyStop(this)">
        Emergency Stop</button
      ><br />
      <hr />
      <form>
        <div class="slider_container">
          <div class="slider_label">Max forward</div>
          <input
            id="maxForwardInput"
            class="slider"
            type="range"
            min="20"
            max="100"
            value="0"
            oninput="return onSliderInput(this)"
          />
          <div id="maxForwardInputValue">0</div>
        </div>

        <div class="slider_container">
          <div class="slider_label">Max backward</div>
          <input
            id="maxBackwardInput"
            class="slider"
            type="range"
            min="15"
            max="40"
            value="0"
            oninput="return onSliderInput(this)"
          />
          <div id="maxBackwardInputValue">0</div>
        </div>
        <button id="saveButton" onclick="return onPressSave(this)">Save</button
        ><br />
      </form>

      <div id="output"></div>

      <div class="file_container">
        <input
          id="newfile"
          class="file_input"
          type="file"
          onchange="upload()"
        />

        <div id="upload">
          <svg
            version="1.1"
            id="upload1"
            xmlns="http://www.w3.org/2000/svg"
            xmlns:xlink="http://www.w3.org/1999/xlink"
            x="0px"
            y="0px"
            viewBox="0 0 384.97 384.97"
            style="enable-background: new 0 0 384.97 384.97"
            xml:space="preserve"
          >
            <g>
              <g id="Upload">
                <path
                  fill="var(--font)"
                  d="M372.939,264.641c-6.641,0-12.03,5.39-12.03,12.03v84.212H24.061v-84.212c0-6.641-5.39-12.03-12.03-12.03
                  S0,270.031,0,276.671v96.242c0,6.641,5.39,12.03,12.03,12.03h360.909c6.641,0,12.03-5.39,12.03-12.03v-96.242
                  C384.97,270.019,379.58,264.641,372.939,264.641z"
                />
              </g>
            </g>
          </svg>
          <svg
            version="1.1"
            id="upload2"
            xmlns="http://www.w3.org/2000/svg"
            xmlns:xlink="http://www.w3.org/1999/xlink"
            x="0px"
            y="0px"
            viewBox="0 0 384.97 384.97"
            style="enable-background: new 0 0 384.97 384.97"
            xml:space="preserve"
          >
            <g>
              <g id="Upload">
                <path
                  fill="var(--font)"
                  d="M117.067,103.507l63.46-62.558v235.71c0,6.641,5.438,12.03,12.151,12.03c6.713,0,12.151-5.39,12.151-12.03V40.95
                  l63.46,62.558c4.74,4.704,12.439,4.704,17.179,0c4.74-4.704,4.752-12.319,0-17.011l-84.2-82.997
                  c-4.692-4.656-12.584-4.608-17.191,0L99.888,86.496c-4.752,4.704-4.74,12.319,0,17.011
                  C104.628,108.211,112.327,108.211,117.067,103.507z"
                />
              </g>
            </g>
          </svg>
        </div>
      </div>

      <script>
        function progressHandler(loaded, total) {
          console.log("Uploaded " + loaded + " bytes of " + total);
          var status = document.getElementById("status");
          var progressBar = document.getElementById("progressBar");

          if (loaded == total) {
            status.innerHTML = "Upload completed!";
            progressBar.value = 100;
          } else {
            var percent = (loaded / total) * 100;
            progressBar.value = Math.round(percent);
            status.innerHTML =
              Math.round(percent) + "% uploaded... please wait";
          }
        }

        function upload() {
          var fileInput = document.getElementById("newfile").files;
          var filePath = fileInput[0].name;
          var upload_path = "/upload/" + filePath;

          document.getElementById("filepath").innerHTML = filePath;

          if (fileInput[0].size > 1000 * 1024) {
            alert("File size must be less than 1000MB!");
          } else {
            showDialog();

            var file = fileInput[0];
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function () {
              if (xhttp.readyState == 4) {
                if (xhttp.status == 200) {
                  document.open();
                  document.write(xhttp.responseText);
                  document.close();
                } else {
                  var status = document.getElementById("status");
                  status.innerHTML =
                    "Server closed the connection abruptly! Please reload the page";
                }
              }
            };
            xhttp.open("POST", upload_path, true);
            xhttp.send(file);
          }
        }
      </script>
    </div>
  </body>
</html>
